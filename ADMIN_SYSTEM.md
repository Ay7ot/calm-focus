# Admin System - Database Schema

## Tables to Create in Supabase

### 1. Admin Roles Table
```sql
-- Add admin role to profiles
alter table profiles add column if not exists role text default 'user';

-- Create index for faster admin checks
create index if not exists profiles_role_idx on profiles(role);

-- Update RLS policy for admin access
create policy "Admins can view all profiles"
  on profiles for select
  to authenticated
  using (
    auth.uid() in (
      select id from profiles where role = 'admin'
    )
  );
```

### 2. Milestones Table
```sql
create table milestones (
  id bigint generated by default as identity primary key,
  title text not null,
  description text,
  session_threshold integer not null,
  badge_icon text,
  badge_color text,
  is_active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()),
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- Enable RLS
alter table milestones enable row level security;

-- Everyone can view active milestones
create policy "Everyone can view active milestones"
  on milestones for select
  using (is_active = true);

-- Only admins can manage milestones
create policy "Admins can manage milestones"
  on milestones for all
  to authenticated
  using (
    auth.uid() in (
      select id from profiles where role = 'admin'
    )
  );
```

### 3. User Achievements Table
```sql
create table user_achievements (
  id bigint generated by default as identity primary key,
  user_id uuid references profiles(id) on delete cascade not null,
  milestone_id bigint references milestones(id) on delete cascade not null,
  unlocked_at timestamp with time zone default timezone('utc'::text, now()),
  unique(user_id, milestone_id)
);

-- Enable RLS
alter table user_achievements enable row level security;

-- Users can view their own achievements
create policy "Users can view own achievements"
  on user_achievements for select
  to authenticated
  using (auth.uid() = user_id);

-- System can insert achievements
create policy "System can insert achievements"
  on user_achievements for insert
  to authenticated
  with check (auth.uid() = user_id);
```

### 4. Daily Tips Table
```sql
create table daily_tips (
  id bigint generated by default as identity primary key,
  content text not null,
  category text default 'general',
  is_active boolean default true,
  created_by uuid references profiles(id),
  created_at timestamp with time zone default timezone('utc'::text, now()),
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- Enable RLS
alter table daily_tips enable row level security;

-- Everyone can view active tips
create policy "Everyone can view active tips"
  on daily_tips for select
  using (is_active = true);

-- Only admins can manage tips
create policy "Admins can manage tips"
  on daily_tips for all
  to authenticated
  using (
    auth.uid() in (
      select id from profiles where role = 'admin'
    )
  );
```

### 5. Update Reminders Table
```sql
-- Add admin fields to reminders
alter table reminders add column if not exists category text default 'personal';
alter table reminders add column if not exists is_recurring boolean default false;
alter table reminders add column if not exists recurrence_pattern text; -- 'daily', 'weekly', etc.
```

### 6. Audit Log Table
```sql
create table admin_audit_log (
  id bigint generated by default as identity primary key,
  admin_id uuid references profiles(id) not null,
  action text not null,
  target_table text,
  target_id text,
  details jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- Enable RLS
alter table admin_audit_log enable row level security;

-- Only admins can view audit log
create policy "Admins can view audit log"
  on admin_audit_log for select
  to authenticated
  using (
    auth.uid() in (
      select id from profiles where role = 'admin'
    )
  );
```

### 7. Initial Milestones Data
```sql
-- Insert default milestones
insert into milestones (title, description, session_threshold, badge_icon, badge_color) values
  ('First Steps', 'Complete your first focus session', 1, 'ğŸŒ±', '#10b981'),
  ('Getting Started', 'Complete 5 focus sessions', 5, 'ğŸ¯', '#3b82f6'),
  ('Building Momentum', 'Complete 10 focus sessions', 10, 'âš¡', '#8b5cf6'),
  ('Consistent Focus', 'Complete 25 focus sessions', 25, 'ğŸ”¥', '#f59e0b'),
  ('Focus Master', 'Complete 50 focus sessions', 50, 'ğŸ’', '#06b6d4'),
  ('Legendary', 'Complete 100 focus sessions', 100, 'ğŸ‘‘', '#f59e0b'),
  ('Unstoppable', 'Complete 250 focus sessions', 250, 'ğŸ†', '#eab308'),
  ('Zen Master', 'Complete 500 focus sessions', 500, 'ğŸ§˜', '#a855f7');
```

---

## How to Create Admins

### Method 1: Direct SQL (Initial Setup)
```sql
-- Make a user admin by email
update profiles 
set role = 'admin' 
where id = (
  select id from auth.users where email = 'your-email@example.com'
);
```

### Method 2: Super Admin Function
```sql
-- Create a function to promote users (only callable by existing admins)
create or replace function promote_to_admin(user_email text)
returns void as $$
begin
  update profiles 
  set role = 'admin', updated_at = now()
  where id = (
    select id from auth.users where email = user_email
  );
end;
$$ language plpgsql security definer;

-- Grant execute to authenticated users (RLS will check admin status)
grant execute on function promote_to_admin to authenticated;
```

### Method 3: Environment Variable (First Admin)
```typescript
// In your app, check for super admin email
const SUPER_ADMIN_EMAIL = process.env.SUPER_ADMIN_EMAIL

// On first login, auto-promote
if (user.email === SUPER_ADMIN_EMAIL) {
  await supabase
    .from('profiles')
    .update({ role: 'admin' })
    .eq('id', user.id)
}
```

---

## Admin Access Control

### 1. Middleware Check
```typescript
// utils/admin.ts
export async function isAdmin(supabase: any) {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return false

  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single()

  return profile?.role === 'admin'
}
```

### 2. Admin Route Protection
```typescript
// app/admin/layout.tsx
export default async function AdminLayout({ children }) {
  const supabase = await createClient()
  const admin = await isAdmin(supabase)

  if (!admin) {
    redirect('/dashboard')
  }

  return <>{children}</>
}
```

### 3. Component-Level Check
```typescript
// Check admin status in components
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single()

const isAdmin = profile?.role === 'admin'
```

---

## Admin Pages Structure

```
app/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ layout.tsx          # Admin layout with sidebar
â”‚   â”œâ”€â”€ page.tsx            # Admin dashboard
â”‚   â”œâ”€â”€ milestones/
â”‚   â”‚   â”œâ”€â”€ page.tsx        # List milestones
â”‚   â”‚   â”œâ”€â”€ new/page.tsx    # Create milestone
â”‚   â”‚   â””â”€â”€ [id]/page.tsx   # Edit milestone
â”‚   â”œâ”€â”€ reminders/
â”‚   â”‚   â”œâ”€â”€ page.tsx        # Manage global reminders
â”‚   â”‚   â””â”€â”€ new/page.tsx    # Create global reminder
â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”œâ”€â”€ page.tsx        # User list
â”‚   â”‚   â””â”€â”€ [id]/page.tsx   # User details
â”‚   â”œâ”€â”€ content/
â”‚   â”‚   â”œâ”€â”€ tips/page.tsx   # Manage daily tips
â”‚   â”‚   â””â”€â”€ posts/page.tsx  # Content moderation
â”‚   â”œâ”€â”€ analytics/
â”‚   â”‚   â””â”€â”€ page.tsx        # Analytics dashboard
â”‚   â””â”€â”€ settings/
â”‚       â””â”€â”€ page.tsx        # System settings
```

---

## Integration Points

### 1. Dashboard - Show Unlocked Achievements
```typescript
// Fetch user's unlocked achievements
const { data: achievements } = await supabase
  .from('user_achievements')
  .select(`
    milestone_id,
    unlocked_at,
    milestones (
      title,
      description,
      badge_icon,
      badge_color
    )
  `)
  .eq('user_id', user.id)
```

### 2. Auto-Unlock Achievements
```typescript
// After completing a session, check for new achievements
const totalSessions = await getTotalSessions(user.id)

const { data: unlockedMilestones } = await supabase
  .from('milestones')
  .select('id')
  .lte('session_threshold', totalSessions)
  .is_active(true)

// Insert achievements user doesn't have yet
for (const milestone of unlockedMilestones) {
  await supabase
    .from('user_achievements')
    .insert({
      user_id: user.id,
      milestone_id: milestone.id
    })
    .onConflict('user_id,milestone_id')
    .ignore()
}
```

### 3. Show Random Daily Tip
```typescript
// In dashboard, fetch random active tip
const { data: tips } = await supabase
  .from('daily_tips')
  .select('content')
  .eq('is_active', true)

const randomTip = tips[Math.floor(Math.random() * tips.length)]
```

### 4. Sidebar - Add Admin Link
```typescript
// Only show for admins
{isAdmin && (
  <Link href="/admin" className="nav-link">
    <Settings size={20} />
    Admin Panel
  </Link>
)}
```

